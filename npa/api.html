<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Programming with the nPA Library &mdash; vsmartcard 2016-06-06 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.4/flatly/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2016-06-06',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../_static/chip.ico"/>
    <link rel="top" title="vsmartcard 2016-06-06 documentation" href="../index.html" />
    <link rel="prev" title="utils Module" href="../virtualsmartcard/api/virtualsmartcard.utils.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">
  
  <a href="https://github.com/frankmorgner/vsmartcard"
     class="visible-desktop hidden-xs"><img
    id="gh-banner"
    style="position: absolute; top: 50px; right: 0; border: 0;"
    src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png"
    alt="Fork me on GitHub"></a>
  <script>
    // Adjust banner height.
    $(function () {
      var navHeight = $(".navbar .container").css("height");
      $("#gh-banner").css("top", navHeight);
    });
  </script>


  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          vsmartcard</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../virtualsmartcard/README.html">Virtual Smart Card</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote-reader/README.html">Remote Smart Card Reader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ACardEmulator/README.html">Android Smart Card Emulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcsc-relay/README.html">PC/SC Relay</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ccid/README.html">USB CCID Emulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html">nPA Smart Card Library</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../virtualsmartcard/api.html">Creating a Virtual Smart Card</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Programming with the nPA Library</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Programming with the nPA Library</a><ul>
<li><a class="reference internal" href="#interface-to-german-identity-card-neuer-personalausweis-npa">Interface to German identity card (neuer Personalausweis, nPA)</a><ul>
<li><a class="reference internal" href="#functions">Functions</a></li>
<li><a class="reference internal" href="#defines">Defines</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example">Example</a></li>
<li><a class="reference internal" href="#generic-iso-7816-secure-messaging-sm">Generic ISO 7816 Secure Messaging (SM)</a><ul>
<li><a class="reference internal" href="#types">Types</a></li>
<li><a class="reference internal" href="#id1">Functions</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../virtualsmartcard/api/virtualsmartcard.utils.html" title="Previous Chapter: utils Module"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; utils Module</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="programming-with-the-npa-library">
<span id="npa-api"></span><h1>Programming with the nPA Library<a class="headerlink" href="#programming-with-the-npa-library" title="Permalink to this headline">¶</a></h1>
<p>The nPA library includes a generic implementation for Secure Messaging (SM),
which might also be used in conjunction with other cards. It is implemented to
be close to ISO 7816 focusing only on encoding rather than implementing
everything that is needed to get a secure channel. All cryptographic work is
done by call back functions, which should be appropriatly set for the specific
card.</p>
<p>Using the German identity card (neuer Personalausweis, nPA) requires user
authentication via entry of the PIN. Transmitting the PIN in plaintext is
risky, since it would be transmitted over the air and could be snooped. That&#8217;s
why the PACE keyagreement is used to verify the PIN and establish an SM channel
to the nPA. <a class="reference external" href="../_static/doxygen-npa/group__npa.html#gaadfcaf886bcf7bfeaaa79d5fd9547819">perform_pace()</a> does exactly that and if everything went fine,
it initializes the card for use of the SM channel. Now <cite>sc_transmit_apdu</cite> or
any other OpenSC command can be used to securely transmit arbitrary APDUs to
the card. Next in the Extended Access Control (EAC) are the Terminal
Authentication (<a class="reference external" href="../_static/doxygen-npa/group__npa.html#ga152ddd07cb17a0a6b6236cb070cb2660">perform_terminal_authentication()</a>) and Chip Authentication
(<a class="reference external" href="../_static/doxygen-npa/group__npa.html#ga193e21a171980fcc0d65e86d887652d6">perform_chip_authentication()</a>). When the EAC was successfull, the card
will be initialized for the new SM channel. Again, libopensc can directly be
used to read identity attributes, for example.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Please consider the following overview to the API as incomplete. The
<a class="reference external" href="../_static/doxygen-npa/modules.html">Doxygen documentation</a> should be
used as programmer&#8217;s reference.</p>
</div>
<div class="section" id="interface-to-german-identity-card-neuer-personalausweis-npa">
<h2>Interface to German identity card (neuer Personalausweis, nPA)<a class="headerlink" href="#interface-to-german-identity-card-neuer-personalausweis-npa" title="Permalink to this headline">¶</a></h2>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="../_static/doxygen-npa/group__npa.html">Doxygen documentation of the nPA module</a>.</p>
</div>
<div class="section" id="functions">
<h3>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt>
<span class="target" id="project0group__npa_1gaadfcaf886bcf7bfeaaa79d5fd9547819"></span><code class="descname">int perform_pace(sc_card_t * card, struct establish_pace_channel_input pace_input, struct establish_pace_channel_output * pace_output, enum eac_tr_version tr_version)</code></dt>
<dd><p>Establish secure messaging using PACE. </p>
<p>Modifies <em>card</em> to use the ISO SM driver and initializes the data structures to use the established SM channel.</p>
<p>Prints certificate description and card holder authorization template if given in a human readable form to stdout. If no secret is given, the user is asked for it. Only <em>pace_input.pin_id</em> is mandatory, the other members of <em>pace_input</em> can be set to <code class="docutils literal"><span class="pre">0</span></code> or <code class="docutils literal"><span class="pre">NULL</span></code> respectively.</p>
<p>The buffers in <em>pace_output</em> are allocated using <code class="docutils literal"><span class="pre">realloc()</span></code> and should be set to NULL, if empty. If an EF.CardAccess is already present, this file is reused and not fetched from the card.</p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd><code class="docutils literal"><span class="pre">SC_SUCCESS</span></code> or error code if an error occurred </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last">
<li><code class="first docutils literal"><span class="pre">card</span></code> - <p></p>
</li>
<li><code class="first docutils literal"><span class="pre">pace_input</span></code> - <p></p>
</li>
<li><code class="first docutils literal"><span class="pre">pace_output</span></code> - <p></p>
</li>
<li><code class="first docutils literal"><span class="pre">tr_version</span></code> - <p>Version of TR-03110 to use with PACE</p>
</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt>
<span class="target" id="project0group__npa_1ga152ddd07cb17a0a6b6236cb070cb2660"></span><code class="descname">int perform_terminal_authentication(sc_card_t * card, const unsigned char ** certs, const size_t * certs_lens, const unsigned char * privkey, size_t privkey_len, const unsigned char * auxiliary_data, size_t auxiliary_data_len)</code></dt>
<dd><p>Terminal Authentication version 2. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd><code class="docutils literal"><span class="pre">SC_SUCCESS</span></code> or error code if an error occurred </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last">
<li><code class="first docutils literal"><span class="pre">card</span></code> - <p></p>
</li>
<li><code class="first docutils literal"><span class="pre">certs</span></code> - <p>chain of cv certificates, the last certificate is the terminal&#8217;s certificate, array should be terminated with <code class="docutils literal"><span class="pre">NULL</span></code> </p>
</li>
<li><code class="first docutils literal"><span class="pre">certs_lens</span></code> - <p>length of each element in <code class="docutils literal"><span class="pre">certs</span></code>, should be terminated with <code class="docutils literal"><span class="pre">0</span></code> </p>
</li>
<li><code class="first docutils literal"><span class="pre">privkey</span></code> - <p>The terminal&#8217;s private key </p>
</li>
<li><code class="first docutils literal"><span class="pre">privkey_len</span></code> - <p>length of <em>privkey</em> </p>
</li>
<li><code class="first docutils literal"><span class="pre">auxiliary_data</span></code> - <p>auxiliary data for age/validity/community ID verification. Should be an ASN1 object tagged with <code class="docutils literal"><span class="pre">0x67</span></code> </p>
</li>
<li><code class="first docutils literal"><span class="pre">auxiliary_data_len</span></code> - <p>length of <em>auxiliary_data</em> </p>
</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt>
<span class="target" id="project0group__npa_1ga193e21a171980fcc0d65e86d887652d6"></span><code class="descname">int perform_chip_authentication(sc_card_t * card, unsigned char ** ef_cardsecurity, size_t * ef_cardsecurity_len)</code></dt>
<dd><p>Establish secure messaging using Chip Authentication version 2. </p>
<p>Switches the SM context of <code class="docutils literal"><span class="pre">card</span></code> to the new established keys.</p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd><code class="docutils literal"><span class="pre">SC_SUCCESS</span></code> or error code if an error occurred </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last">
<li><code class="first docutils literal"><span class="pre">card</span></code> - <p></p>
</li>
<li><code class="first docutils literal"><span class="pre">ef_cardsecurity</span></code> - <p></p>
</li>
<li><code class="first docutils literal"><span class="pre">ef_cardsecurity_len</span></code> - <p></p>
</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt>
<span class="target" id="project0group__npa_1ga4c7507f8f35c39d4d24766d51fb868cb"></span><code class="descname">int npa_reset_retry_counter(sc_card_t * card, enum s_type pin_id, int ask_for_secret, const char * new, size_t new_len)</code></dt>
<dd><p>Sends a reset retry counter APDU. </p>
<p>According to TR-03110 the reset retry counter APDU is used to set a new PIN or to reset the retry counter of the PIN. The standard requires this operation to be authorized either by an established PACE channel or by the effective authorization of the terminal&#8217;s certificate.</p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd><code class="docutils literal"><span class="pre">SC_SUCCESS</span></code> or error code if an error occurred </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last">
<li><code class="first docutils literal"><span class="pre">card</span></code> - <p></p>
</li>
<li><code class="first docutils literal"><span class="pre">pin_id</span></code> - <p>Type of secret (usually PIN or CAN). You may use <code class="docutils literal"><span class="pre">enum</span> <span class="pre">s_type</span></code> from <code class="docutils literal"><span class="pre">&lt;openssl/pace.h&gt;</span></code>. </p>
</li>
<li><code class="first docutils literal"><span class="pre">ask_for_secret</span></code> - <p>whether to ask the user for the secret (<code class="docutils literal"><span class="pre">1</span></code>) or not (<code class="docutils literal"><span class="pre">0</span></code>) </p>
</li>
<li><code class="first docutils literal"><span class="pre">new</span></code> - <p>(optional) new secret </p>
</li>
<li><code class="first docutils literal"><span class="pre">new_len</span></code> - <p>(optional) length of <em>new</em> </p>
</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

</div>
<div class="section" id="defines">
<h3>Defines<a class="headerlink" href="#defines" title="Permalink to this headline">¶</a></h3>
<dl class="macro">
<dt id="c.npa_change_pin">
<span class="target" id="project0group__npa_1gab81a918e060f80ac74c26b15222a092a"></span><code class="descname">npa_change_pin</code><span class="sig-paren">(</span>card, newp, newplen<span class="sig-paren">)</span><a class="headerlink" href="#c.npa_change_pin" title="Permalink to this definition">¶</a></dt>
<dd><p>Send APDU to set a new PIN. </p>
<p><dl class="docutils">
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last">
<li><code class="first docutils literal"><span class="pre">card</span></code> - <p></p>
</li>
<li><code class="first docutils literal"><span class="pre">newp</span></code> - <p>(optional) new PIN </p>
</li>
<li><code class="first docutils literal"><span class="pre">newplen</span></code> - <p>(optional) length of <em>new</em> </p>
</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="macro">
<dt id="c.npa_unblock_pin">
<span class="target" id="project0group__npa_1gac48a5e211dbe2e4129b1b05cc5323aaa"></span><code class="descname">npa_unblock_pin</code><span class="sig-paren">(</span>card<span class="sig-paren">)</span><a class="headerlink" href="#c.npa_unblock_pin" title="Permalink to this definition">¶</a></dt>
<dd><p>Send APDU to unblock the PIN. </p>
<p><dl class="docutils">
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last">
<li><code class="first docutils literal"><span class="pre">card</span></code> - <p></p>
</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

</div>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>In order to compile and execute this example you need to correctly <a class="reference internal" href="README.html#npa-usage"><span>set up
your environment</span></a>.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cm">/* This example shows how to use the library functions perform_pace to</span>
<span class="cm"> * get a secure channel to the nPA. We use the builtin function npa_change_pin</span>
<span class="cm"> * to modify the PIN using the secure channel. Then we transmit an arbitrary</span>
<span class="cm"> * APDU encrypted and authenticated to the card using sm_transmit_apdu. */</span>
<span class="cp">#ifdef HAVE_CONFIG_H</span>
<span class="cp">#include &quot;config.h&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;libopensc/sm.h&gt;</span>
<span class="cp">#include &lt;npa/iso-sm.h&gt;</span>
<span class="cp">#include &lt;npa/npa.h&gt;</span>
<span class="cp">#include &lt;npa/scutil.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">reader_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">newpin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/* SELECT the Master File (MF) */</span>
<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">apdubuf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Set up the environment */</span>
    <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

    <span class="kt">sc_context_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">sc_card_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">sc_reader_t</span> <span class="o">*</span><span class="n">reader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="kt">sc_apdu_t</span> <span class="n">apdu</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0xffff</span><span class="p">];</span>

    <span class="k">struct</span> <span class="n">establish_pace_channel_input</span> <span class="n">pace_input</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">establish_pace_channel_output</span> <span class="n">pace_output</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pace_input</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">pace_input</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pace_output</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">pace_output</span><span class="p">);</span>


    <span class="cm">/* Connect to a reader and the nPA */</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">initialize</span><span class="p">(</span><span class="n">reader_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reader</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Can&#39;t initialize reader</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sc_connect_card</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Could not connect to card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">sc_release_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* initialize OpenPACE */</span>
    <span class="n">EAC_init</span><span class="p">();</span>


    <span class="cm">/* Now we try to change the PIN. Therefor we need to establish a SM channel</span>
<span class="cm">     * with PACE.</span>
<span class="cm">     *</span>
<span class="cm">     * You could set your PIN with pin=“123456”; or just leave it at NULL to be</span>
<span class="cm">     * asked for it. The same applies to the new PIN newpin. */</span>
    <span class="n">pace_input</span><span class="p">.</span><span class="n">pin_id</span> <span class="o">=</span> <span class="n">PACE_PIN</span><span class="p">;</span>
    <span class="n">pace_input</span><span class="p">.</span><span class="n">pin</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pin</span><span class="p">;</span>
    <span class="n">pace_input</span><span class="p">.</span><span class="n">pin_length</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">perform_pace</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pace_input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pace_output</span><span class="p">,</span> <span class="n">EAC_TR_VERSION_2_02</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Established PACE channel with PIN.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">npa_change_pin</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">newpin</span><span class="p">,</span> <span class="n">newpin</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">newpin</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Changed PIN.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


    <span class="cm">/* Now we want to transmit additional APDUs in the established SM channel.</span>
<span class="cm">     *</span>
<span class="cm">     * Here we are parsing the raw apdu buffer apdubuf to be transformed into</span>
<span class="cm">     * an sc_apdu_t. Alternatively you could also set CLA, INS, P1, P2, ... by</span>
<span class="cm">     * hand in the sc_apdu_t object. */</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sc_bytes2apdu</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">apdubuf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">apdubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apdu</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

    <span class="cm">/* write the response data to buf */</span>
    <span class="n">apdu</span><span class="p">.</span><span class="n">resp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">apdu</span><span class="p">.</span><span class="n">resplen</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">;</span>

    <span class="cm">/* Transmit the APDU with SM */</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sc_transmit_apdu</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apdu</span><span class="p">);</span>


<span class="nl">err</span><span class="p">:</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nl">stderr</span> <span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sc_strerror</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>

    <span class="cm">/* Free up memory and wipe it if necessary (e.g. for keys stored in sm_ctx) */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pace_output</span><span class="p">.</span><span class="n">ef_cardaccess</span><span class="p">)</span>
        <span class="n">free</span><span class="p">(</span><span class="n">pace_output</span><span class="p">.</span><span class="n">ef_cardaccess</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pace_output</span><span class="p">.</span><span class="n">recent_car</span><span class="p">)</span>
        <span class="n">free</span><span class="p">(</span><span class="n">pace_output</span><span class="p">.</span><span class="n">recent_car</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pace_output</span><span class="p">.</span><span class="n">previous_car</span><span class="p">)</span>
        <span class="n">free</span><span class="p">(</span><span class="n">pace_output</span><span class="p">.</span><span class="n">previous_car</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pace_output</span><span class="p">.</span><span class="n">id_icc</span><span class="p">)</span>
        <span class="n">free</span><span class="p">(</span><span class="n">pace_output</span><span class="p">.</span><span class="n">id_icc</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pace_output</span><span class="p">.</span><span class="n">id_pcd</span><span class="p">)</span>
        <span class="n">free</span><span class="p">(</span><span class="n">pace_output</span><span class="p">.</span><span class="n">id_pcd</span><span class="p">);</span>

    <span class="n">sc_sm_stop</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
    <span class="n">sc_reset</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">sc_disconnect_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
    <span class="n">sc_release_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
    <span class="n">EAC_cleanup</span><span class="p">();</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="generic-iso-7816-secure-messaging-sm">
<h2>Generic ISO 7816 Secure Messaging (SM)<a class="headerlink" href="#generic-iso-7816-secure-messaging-sm" title="Permalink to this headline">¶</a></h2>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="../_static/doxygen-npa/group__sm.html">Doxygen documentation of the SM module</a>.</p>
</div>
<div class="section" id="types">
<h3>Types<a class="headerlink" href="#types" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="_CPPv210iso_sm_ctx">
<span id="iso_sm_ctx"></span><span class="target" id="project0structiso__sm__ctx"></span><em class="property">struct </em><code class="descclassname"></code><code class="descname">iso_sm_ctx</code><a class="headerlink" href="#_CPPv210iso_sm_ctx" title="Permalink to this definition">¶</a></dt>
<dd><p>Secure messaging context. </p>
</dd></dl>

</div>
<div class="section" id="id1">
<h3>Functions<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="_CPPv217iso_sm_ctx_createv">
<span id="iso_sm_ctx_create__void"></span><span class="target" id="project0group__sm_1ga4adeb0bb2adcadf9847e578abff4d245"></span><em class="property">struct</em> <a class="reference internal" href="#_CPPv210iso_sm_ctx" title="iso_sm_ctx">iso_sm_ctx</a> *<code class="descclassname"></code><code class="descname">iso_sm_ctx_create</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv217iso_sm_ctx_createv" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates a SM context. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>SM context or NULL if an error occurred </dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv221iso_sm_ctx_clear_freeP10iso_sm_ctx">
<span id="iso_sm_ctx_clear_free__iso_sm_ctxP"></span><span class="target" id="project0group__sm_1gaf4fcb7951774725d8cd074fcbe177dcd"></span>void <code class="descclassname"></code><code class="descname">iso_sm_ctx_clear_free</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#_CPPv210iso_sm_ctx" title="iso_sm_ctx">iso_sm_ctx</a> *<em>sctx</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv221iso_sm_ctx_clear_freeP10iso_sm_ctx" title="Permalink to this definition">¶</a></dt>
<dd><p>Clears and frees the SM context including private data. </p>
<p>Calls <em>sctx-&gt;clear_free()</em> if available</p>
<p><dl class="docutils">
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last">
<li><code class="first docutils literal"><span class="pre">sctx</span></code> - <p>(optional) </p>
</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv212iso_sm_startP7sc_cardP10iso_sm_ctx">
<span id="iso_sm_start__sc_cardP.iso_sm_ctxP"></span><span class="target" id="project0group__sm_1ga7b8d897ead1ce15c321e6e3957f8ac72"></span>int <code class="descclassname"></code><code class="descname">iso_sm_start</code><span class="sig-paren">(</span><em class="property">struct</em> sc_card *<em>card</em>, <em class="property">struct</em> <a class="reference internal" href="#_CPPv210iso_sm_ctx" title="iso_sm_ctx">iso_sm_ctx</a> *<em>sctx</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv212iso_sm_startP7sc_cardP10iso_sm_ctx" title="Permalink to this definition">¶</a></dt>
<dd><p>Initializes a card for usage of the ISO SM driver. </p>
<p>If a SM module has been assigned previously to the card, it will be cleaned up.</p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd><code class="docutils literal"><span class="pre">SC_SUCCESS</span></code> or error code if an error occurred </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last">
<li><code class="first docutils literal"><span class="pre">card</span></code> - <p></p>
</li>
<li><code class="first docutils literal"><span class="pre">sctx</span></code> - <p>will NOT be freed automatically. <em>sctx</em> should be present for the time of the SM session.</p>
</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2009-2016 by Dominik Oepen and Frank Morgner.<br/>
    </p>
  </div>
</footer>
  </body>
</html>